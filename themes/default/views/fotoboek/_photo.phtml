<?php
$like_model = get_model('DataModelFotoboekLikes');
$likes = count($like_model->get_for_photo($iter));
$liked = logged_in() && $like_model->is_liked($iter, logged_in('id'));
?>
<? if (member_in_commissie(COMMISSIE_FOTOCIE)) { ?>
	<div class="foto_titel"><form method="post" action="fotoboek.php?photo=<?= $iter->get('id') ?>">
	<?= input_hidden('submfotobeschrijving', 'yes') ?>
	<?= input_text('beschrijving', $iter->data) . ' ' . input_submit('subm', __('Opslaan')) ?>
	</form></div>
<? } elseif ($iter->get('beschrijving')) { ?>
	<div class="foto_titel"><?= htmlspecialchars($iter->get('beschrijving')) ?></div>
<? } ?>

<div id="foto" class="fotoboek_foto">
<?
	$prev = $model->get_previous_photo($iter, 2);
	$next = $model->get_next_photo($iter, 2);
?>
<div class="photo <?=$liked ? 'liked' : ''?>">
	<nav class="photo-controls">
		<?php if (logged_in()): ?>
		<form class="like-form" method="post" action="fotoboek.php?photo=<?=$iter->get_id()?>&amp;module=likes">
			<input type="hidden" name="action" value="toggle">
			<button type="submit" class="like-button like-count" title="<?=markup_format_attribute($liked ? __('Haal markering als favoriet weg') : __('Markeer als favoriet')) ?>"><?=$likes?></button>
		</form>
		<?php endif ?>
		<?php if (count($prev) > 0): ?>
		<a href="fotoboek.php?photo=<?= $prev[0]->get('id') ?>#a" class="prev-button" title="<?= markup_format_attribute(__('Ga naar vorige foto')) ?>"><?=__('Vorige')?></a>
		<?php endif ?>
		<?php if (count($next) > 0): ?>
		<a href="fotoboek.php?photo=<?= $next[0]->get('id') ?>#a" class="next-button" title="<?= markup_format_attribute(__('Ga naar volgende foto')) ?>"><?=__('Volgende')?></a>
		<?php endif ?>
	</nav>
	<a href="fotoboek.php?book=<?= $iter->get('boek') ?>#photo_<?= $iter->get('id') ?>">
		<img id="photo" src="<?=htmlspecialchars($iter->get('url'), ENT_QUOTES) ?>" alt="<?= __('Foto') ?>">
	</a>
</div>
</div>
<script type = "text/javascript">
	$(document).ready(function(){
		$(document).on('keyup.nav',function(event){keyPress(event);});
		$("textarea[name='reactie']").focus(function(){$(document).off('keyup.nav')}).blur(function(){$(document).on('keyup.nav', function(event){keyPress(event);})});
	});
	
	function keyPress(event)
	{
		if(event.keyCode == 37 && $(".prevPhoto > a").attr("href") != undefined)
			window.location.href = $(".prevPhoto > a").attr("href");
		else if (event.keyCode == 39 && $(".nextPhoto > a").attr("href") != undefined)
			window.location.href = $(".nextPhoto > a").attr("href");
		else if (event.keyCode == 38)
			window.location.href = $(".fotoboek_path_current > a").attr("href");
	}

	<?php if (logged_in()): ?>
	$('.like-form').submit(function(e) {
		e.preventDefault();
		$form = $(this);
		var labels = [
			<?=json_encode(__('Haal markering als favoriet weg'))?>,
			<?=json_encode(__('Markeer als favoriet'))?>
		];
		$.post($form.attr('action'), $form.serializeArray(), function(response) {
			$form.closest('.photo').toggleClass('liked', response.liked);
			$form.find('.like-button').attr('title', labels[response.liked ? 0 : 1]);
			$form.find('.like-count').text(response.likes);
		});
	});
	<?php endif ?>
</script>
