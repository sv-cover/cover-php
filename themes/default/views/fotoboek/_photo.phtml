<?php
$like_model = get_model('DataModelFotoboekLikes');
$likes = count($like_model->get_for_photo($iter));
$liked = logged_in() && $like_model->is_liked($iter, logged_in('id'));

$photo_of_current_user = false;
$photo_is_visible = true;
$faces = get_model('DataModelFotoboekFaces')->get_for_photo($iter);

if (logged_in()) {
	// Determine whether this photo would normally show up in photos of me.
	foreach ($faces as $face) {
		if ($face->has('lid_id') && $face->get('lid_id') == logged_in('id')) {
			$photo_of_current_user = true;
			break;
		}
	}

	$privacy_model = get_model('DataModelFotoboekPrivacy');
	$photo_is_visible = $privacy_model->is_visible($iter, logged_in_member());
}

?>
<?php if (member_in_commissie(COMMISSIE_FOTOCIE)): ?>
	<div class="foto_titel">
		<form method="post" action="fotoboek.php?book=<?=$book->get_id()?>&amp;photo=<?=$iter->get_id() ?>&amp;view=update_photo">
			<?= input_text('beschrijving', $iter->data) . ' ' . input_submit('subm', __('Opslaan')) ?>
		</form>
	</div>
<?php elseif ($iter->get('beschrijving')): ?>
	<div class="foto_titel"><?=markup_format_text($iter->get('beschrijving')) ?></div>
<?php endif ?>

<div id="foto" class="fotoboek_foto">
<?php
	$prev = $book->get_previous_photo($iter, 1);
	$next = $book->get_next_photo($iter, 1);
?>
<div class="photo <?=$liked ? 'liked' : ''?>">
	<nav class="photo-controls navigation">
		<?php if (count($prev) > 0): ?>
		<a href="fotoboek.php?book=<?=$book->get_id()?>&amp;photo=<?= $prev[0]->get_id() ?>" class="prev-button previous" title="<?= markup_format_attribute(__('Ga naar vorige foto')) ?>">
			<?=__('Vorige')?>
		</a>
		<?php endif ?>

		<?php if (count($next) > 0): ?>
		<a href="fotoboek.php?book=<?=$book->get_id()?>&amp;photo=<?= $next[0]->get_id() ?>" class="next-button next" title="<?= markup_format_attribute(__('Ga naar volgende foto')) ?>">
			<?=__('Volgende')?>
		</a>
		<?php endif ?>
		
		<?php if (logged_in()): ?>
		<form class="like-form" method="post" action="fotoboek.php?photo=<?=$iter->get_id()?>&amp;module=likes">
			<input type="hidden" name="action" value="toggle">
			<button type="submit" class="like-button like-count"
				title="<?=markup_format_attribute($liked ? __('Haal markering als favoriet weg') : __('Markeer als favoriet')) ?>"
				data-title="<?=markup_format_attribute(json_encode([__('Haal markering als favoriet weg'), __('Markeer als favoriet')]))?>"
				><?=$likes?></button>
		</form>

		<input id="tagging-toggle" type="checkbox">
		<label for="tagging-toggle"><i class="fa fa-tag"></i> <?=__('Tag gezichten')?></label>
		
		<a href="fotoboek.php?photo=<?=$iter->get_id()?>&amp;view=download"><i class="fa fa-download"></i> <?=__('Download')?></a>
		<?php endif ?>
		
		<?php if ($photo_of_current_user): ?>
		<a href="fotoboek.php?photo=<?=$iter->get_id()?>&amp;module=privacy" data-placement-selector="modal" data-partial-selector=".privacy-preference-form">
			<i class="fa fa-eye-slash"></i>
			<?=__('Zichtbaarheid')?>
		</a>
		<?php endif ?>
	</nav>
	
	<div id="photo" data-id="<?=$iter->get_id()?>" <?php if (get_policy('DataModelFotoboekFaces')->user_can_create()) printf('data-create-action="%s"', markup_format_attribute($faces_controller->link_to_create())) ?>>
		<figure class="full-size-photo <?=$iter['orientation']?>">
			<img
				src="<?=markup_format_attribute($iter->get_url(1600, 1600)) ?>"
				data-preview="<?=markup_format_attribute($iter->get_url(null, 400)) ?>"
				<?=vsprintf('width="%d" height="%d"', $iter->get_scaled_size(820, 820))?>>
		</figure>

		<?php foreach ($faces as $face): ?>
		<div id="face_<?=$face->get_id()?>" class="face <?=$face->has('lid_id') || $face->has('custom_label') ? 'tagged' : 'untagged' ?> <?php if ($face->has('lid_id') && $face->get('lid_id') == logged_in('id')) echo 'me' ?>" style="<?=vsprintf("left: %0.2F%%; top: %0.2F%%; width: %0.2F%%; height: %0.2F%%;", $face->get_position())?>"
			<?php if (get_policy($face->model)->user_can_delete($face)) printf('data-delete-action="%s"',
				markup_format_attribute($faces_controller->link_to_delete($face))) ?>
			<?php if (get_policy($face->model)->user_can_update($face)) printf('data-update-action="%s"',
				markup_format_attribute($faces_controller->link_to_update($face))) ?>>
			<!-- name label (and hidden update form) -->
			<div class="tag-label">
				<?php if ($face->has('lid_id')): $lid = $face->getIter('lid'); ?>
				<a href="profiel.php?lid=<?=$lid->get_id()?>" class="name"><?=markup_format_text(member_full_name($lid, BE_PERSONAL))?></a>
				<?php elseif ($face->has('custom_label')): ?>
				<a class="name" href="#"><?=markup_format_text($face->get('custom_label'))?></a>
				<?php elseif (get_policy($face->model)->user_can_update($face)): ?>
				<a class="name" href="#"><?=__('Klik om te taggen')?></a>
				<?php else: ?>
				<a class="name" href="#"><?=__('Niet getagged')?></a>
				<?php endif ?>
			</div>
		</div>
		<?php endforeach ?>
	</div>	
</div>
</div>
<script type = "text/javascript">
	$(document).ready(function(){
		$(document).on('keyup.nav', function(event){
			// Only catch unspecific input (so no form elements)
			if (['TEXTAREA', 'INPUT'].indexOf(event.target.nodeName) === -1)
				keyPress(event);
		});
	});
	
	function keyPress(event)
	{
		if(event.keyCode == 37 && $(".prev-button").attr("href") != undefined)
			window.location.href = $(".prev-button").attr('href');
		else if (event.keyCode == 39 && $(".next-button").attr("href") != undefined)
			window.location.href = $(".next-button").attr('href');
		else if (event.keyCode == 38)
			window.location.href = $("#path a:last-child").attr("href");
	}
</script>
