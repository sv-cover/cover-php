<h1><?= sprintf(__('Profiel van %s'), member_full_name($iter, false, false)) ?></h1>
<div class="messageBox clearfix">


<? if (isset($errors) && count($errors) > 0) { ?>
	<p><span class="error"><?= __('Niet alle velden zijn goed ingevuld') ?></span></p>
		
		<? if (isset($error_message)) {?>
		<div class="error_message"><?= str_replace("\n", "<br>\n", $error_message) ?></div>
		<? } ?>
<? } ?>

	<div class="floatLeft textCenter almanak">
		<h2 id="almanak" class="profileHead"><?= __('Almanakgegevens') ?></h2>
			<? $photo_link = "foto.php?lid_id=" . $model->get_photo_id($iter);
			$photo_thumb_link = "foto.php?get_thumb&lid_id=" . $model->get_photo_id($iter);

			if ($model->has_picture($iter) && !$model->is_private($iter,"foto",true)) {
				// Make the picture a link ?>
				<a class="profielFoto" href="<?= htmlspecialchars($photo_link, ENT_QUOTES) ?>"><img width="100" height="150" src="<?= htmlspecialchars($photo_thumb_link, ENT_QUOTES) ?>" class="profielFoto" alt= "<?= __('lidfoto') ?>"/></a>
			<? } else { ?>
				<img width="100" height="150" class="profielFoto" src="<?= htmlspecialchars($photo_link, ENT_QUOTES) ?>" />
			<? } ?>
			<p class="hint"><?=__('Niet tevreden met je foto? Stuur een nieuwe naar webcie@ai.rug.nl. Het liefst 500&times;750 groot.')?></p>
			<form action="profiel.php?lid=<?= $iter->get('lidid') ?>#almanak" method="post">
				<?= input_hidden('submprofiel_almanak', 'yes') ?>
				<?= input_hidden('id', $iter->get('lidid')) ?>
				<table class="profiel">
					<tr>
						<td width="150"></td>
						<td></td>
					</tr>
					<?
					if (member_in_commissie(COMMISSIE_BESTUUR)) { ?>
						<tr><td><?=
								//FIXME: Omdat 'naam' geen echt veld is, worden velden met errors hier (bijv. voornaam die te lang is) niet aangegeven -- PdB
						 label(__('Naam'), 'naam', $errors) ?>:</td><td>
							 <?= input_text('voornaam', $iter->data, 'class', 'naam') ?>
							 <?= input_text('tussenvoegsel', $iter->data, 'class', 'naam') ?>
							 <?= input_text('achternaam', $iter->data, 'class', 'naam') ?></td></tr>

					<?
						$fields = array();			
					} else { 
						$fields = array(array('label' => __('Naam'), 'name' => 'naam', 'data' => array('naam' => member_full_name($iter, false, false)), 'read_only' => true));
					} 

					$fields = array_merge($fields, array(
						array('label' => __('Geboortedatum'), 'name' => 'geboortedatum', 'data' => array('geboortedatum' => format_date($iter->get('geboortedatum'))), 'read_only' => true),
						array('label' => __('Beginjaar'), 'name' => 'beginjaar', 'read_only' => true),
						array('label' => __('Adres'), 'name' => 'adres'),
						array('label' => __('Postcode'), 'name' => 'postcode'),
						array('label' => __('Woonplaats'), 'name' => 'woonplaats'),
						array('label' => __('Tel. vast'), 'name' => 'telefoonnummer_vast'),
						array('label' => __('Tel. mobiel'), 'name' => 'telefoonnummer_mobiel'),
						array('label' => __('E-Mail adres'), 'name' => 'email')));

					foreach ($fields as $field) {?>
						<?= $this->privacy_parse($model, $iter, $field['label'], $field['name'], (isset($field['data']) ? $field['data'] : $iter->data), $errors, isset($field['read_only']) ? $field['read_only'] : false) ?>
					<? } ?>

					<? if ($this->member_write_permission($iter->get('lidid'))) {?>
						<tr><td colspan="2" class="submit"><?= input_submit('subm', __('Opslaan')) ?></td></tr>
					<? } ?>
				</table>
			</form>
	</div>
	
	<div class="floatLeft almanak">
			<h2 id="webgegevens" class="profilehead"><?= __('Webgegevens') ?></h2>
			<form action="profiel.php?lid=<?= $iter->get('lidid') ?>#webgegevens" method="post">
				<?= input_hidden('submprofiel_webgegevens', 'yes') ?>
				<?= input_hidden('id', $iter->get('lidid')) ?>

				<table class="profiel">
					<tr>
						<td width="150"></td>
						<td></td>
					</tr>
					<?= $this->privacy_parse($model, $iter, __('Bijnaam'), 'nick', $iter->data, $errors) ?>
					<?= $this->privacy_parse($model, $iter, __('Onderschrift'), 'onderschrift', $iter->data, $errors) ?>

					<? /* Avatar */ ?>
					<tr><td><?= label(__('Avatar'), 'avatar', $errors) ?>:</td>

					<? if ($this->is_current_member($iter->get('lidid'))) {?>
						<td><?= input_text('avatar', $iter->data, 'formatter',  'empty_to_http_formatter') ?></td>
					<?} else {?>
						<td><?= ($iter->get('avatar') ? ('<img src="' . htmlspecialchars($iter->get('avatar'), ENT_QUOTES) . '" alt="' . __('avatar') . '">') : ('<span class="italic">' . __('geen') . '</span>')) ?></td>
					<? } ?>
					</tr>

					<? /* Homepage */ ?>
					<tr><td><?= label(__('Homepage'), 'homepage', $errors) ?>:</td>

					<? if ($this->is_current_member($iter->get('lidid'))) {?>
						<td><?= input_text('homepage', $iter->data, 'formatter', 'empty_to_http_formatter') ?></td>		
					<?} else {?>
						<td><?= ($iter->get('homepage') ? ('<a href="' . htmlspecialchars($iter->get('homepage'), ENT_QUOTES) . '">' . htmlspecialchars($iter->get('homepage')) . '</a>') : ('<span class="italic">' . __('geen') . '</span>')) ?></td>
					<? } ?>
					</tr>

					<? if ($this->member_write_permission($iter->get('lidid'))) {?>
						<tr>
							<td><?= label(__('Taal'), 'taal', $errors) ?></td>
							<td><?= select_field('taal', i18n_get_languages(), $iter->data) ?></td>
						</tr>
					<? } ?>

					<? if ($this->member_write_permission($iter->get('lidid'))) {?>
						<tr><td colspan="2" class="submit"><?= input_submit('subm', __('Opslaan')) ?></td></tr>
					<? } ?>
				</table>
			</form>
	</div>

	<?php if (member_in_commissie(COMMISSIE_BESTUUR)) { ?>
		<div class="floatLeft almanak">
			<h2 class="profilehead" id="zichtbaarheid"><?= __('Zichtbaarheid') ?></h2>
			<form action="profiel.php?lid=<?= $iter->get('lidid') ?>#zichtbaarheid" method="post">

				<?= input_hidden('submprofiel_zichtbaarheid', 'yes') ?>
				<?= input_hidden('id', $iter->get('lidid')) ?>

				<table class="profiel">
					<tr>
						<td width="120"><span class="label">Type:</span></td>
						<td width="150"><label><?=input_radio('type', $iter->data, MEMBER_STATUS_LID) . '&nbsp;' . __('Lid') ?></label></td>
					</tr>
					<tr>
						<td></td>
						<td><label><?=input_radio('type', $iter->data, MEMBER_STATUS_LID_ONZICHTBAAR) . '&nbsp;' . __('Lid (verborgen)') ?></label></td>
					</tr>
					<tr>
						<td></td>
						<td><label><?=input_radio('type', $iter->data, MEMBER_STATUS_LID_AF) . '&nbsp;' . __('Lid af') ?></label></td>
					</tr>
					<tr>
						<td></td>
						<td><label><?=input_radio('type', $iter->data, MEMBER_STATUS_ERELID) . '&nbsp;' . __('Erelid') ?></label></td>
					</tr>
					<tr>
						<td></td>
						<td><label><?=input_radio('type', $iter->data, MEMBER_STATUS_DONATEUR) . '&nbsp;' . __('Donateur') ?></label></td>
					</tr>
					<tr>
						<td colspan="2" class="submit"><?= input_submit('subm', __('Opslaan')) ?></td>
					</tr>
				</table>
			</form>
		</div>
	<?php } ?>

	<?php if ($commissies = $this->get_commissies($iter)): ?>
	<div class="floatLeft almanak">
		<h2 class="profilehead" id="commissies"><?= __('Commissies') ?></h2>
		<p><?= htmlspecialchars(__('Lid van de volgende commissies:')) ?></p>
		<ul>
			<?php foreach ($commissies as $commissie): ?>
			<li>
				<a href="show.php?id=<?=$commissie->get('page')?>"><?=htmlspecialchars($commissie->get('naam'))?></a>
				- <span class="functie"><?=htmlspecialchars(__translate_parts($commissie->get('functie'), ',/')) ?></span>
			</li>
			<?php endforeach ?>
		</ul>
	</div>
	<?php endif ?>

	<? if ($this->member_write_permission($iter->get('lidid'))) { ?>
		<div class="floatLeft almanak">
			<h2 class="profilehead" id="wachtwoord"><?= __('Nieuw wachtwoord') ?></h2>
				<form action="profiel.php?lid=<?= $iter->get('lidid') ?>#wachtwoord" method="post">
	
					<?= input_hidden('submprofiel_wachtwoord', 'yes') ?>
					<?= input_hidden('id', $iter->get('lidid')) ?>
	
					<table class="profiel">
						<tr>
							<td width="150"></td>
							<td></td>
						</tr>
						<?php if (!member_in_commissie(COMMISSIE_BESTUUR)): ?>
						<?= table_row(label(__('Oud wachtwoord'), 'wachtwoord_oud', $errors) . ':', input_password('wachtwoord_oud')) ?>
						<?php endif ?>
						<?= table_row(label(__('Nieuw wachtwoord'), 'wachtwoord_nieuw', $errors) . ':', input_password('wachtwoord_nieuw')) ?>
						<?= table_row(label(__('Opnieuw'), 'wachtwoord_opnieuw', $errors) . ':', input_password('wachtwoord_opnieuw')) ?>
	
						<tr><td colspan="2" class="submit"><?= input_submit('subm', __('Opslaan')) ?></td></tr>
					</table>
				</form>
		</div>

		<div class="almanak clearBoth">
			<h2 class="profilehead" id="privacy"><?= __('Privacy instellingen') ?></h2>
			<p><?= __('Je privacy instellingen geven aan wie welke informatie mag zien.') ?></p>
			<form action="profiel.php?lid=<?= $iter->get('lidid') ?>#privacy" method="post">
				<?= input_hidden('submprofiel_privacy', 'yes') ?>
				<?= input_hidden('id', $iter->get('lidid')) ?>
		
				<table class="privacy">
					<tr class="header">
						<td class="corner"></td>
						<td><?= __('Niemand') ?></td>
						<td><?= __('Leden') ?></td>
						<td><?= __('Iedereen') ?></td>
					</tr>
		
					<? /* Get privacy fields */
					$fields = $model->get_privacy();
					$privacy = $iter->get('privacy');
		
					foreach ($fields as $field => $nr) {
						/* Get the 3bit value */
						$value = (($privacy >> ($nr * 3)) & 7);
						$data = array('privacy_' . $nr => $value);
		
						/* Create privacy row */ ?>
					<tr>
						<td class="bold"><?= field_for_display($field) ?></td>
						<td class="text_center"><?= input_radio('privacy_' . $nr, $data, '0') ?></td>
						<td class="text_center"><?= input_radio('privacy_' . $nr, $data, '1') ?></td>
						<td class="text_center"><?= input_radio('privacy_' . $nr, $data, '7') ?></td>
					</tr>
							<? } ?>
		
					<tr>
						<td colspan="4" class="submit"><?= input_submit('subm', __('Opslaan')) ?></td>
					</tr>
				</table>
			</form>
		</div>
	<? } ?>
</div>

<h2><?= __('Mailinglijsten')?></h2>
<? if($this->is_current_member($iter->get('lidid'))): ?>
	<div class="messageBox">
		<p><?= sprintf(__('Je bent aangemeld voor %d mailinglijsten.'), $this->get_active_subscription_count($iter->get('lidid'))) ?> <a href="mailinglijsten.php"><?= __('Beheer je abonnementen.') ?></a></p>
	</div>
<?php elseif (member_in_commissie(COMMISSIE_EASY)): ?>
	<div class="messageBox">
		<p><?= sprintf(__('Deze persoon is aangemeld voor %d mailinglijsten.'), $this->get_active_subscription_count($iter->get('lidid'))) ?> <a href="mailinglijsten.php?lid_id=<?=$iter->get('lidid') ?>"><?= __('Beheer zijn/haar abonnementen.') ?></a></p>
	</div>
<?php endif ?>

<h2><?= __('Sessies')?></h2>
<? if($this->is_current_member($iter->get('lidid'))): ?>
	<div class="messageBox">
		<p><?= sprintf(__('Je bent ingelogd met %d browsers.'), $this->get_active_session_count($iter->get('lidid'))) ?> <a href="sessions.php"><?= __('Beheer je sessies.') ?></a></p>
	</div>
<?php elseif (member_in_commissie(COMMISSIE_EASY)): ?>
	<div class="messageBox">
		<p><?= sprintf(__('Deze persoon is ingelogd met %d browsers.'), $this->get_active_session_count($iter->get('lidid'))) ?> <a href="sessions.php?lidid=<?=$iter->get('lidid') ?>"><?= __('Beheer zijn/haar sessies.') ?></a></p>
	</div>
<?php endif ?>

	
<? if($this->is_current_member($iter->get('lidid'))) { ?>
	<h2 id="msdnaa"><?=__('Dreamspark (voorheen MSDNAA)')?></h2>
	
	<script type="text/javascript">
	$().ready(function() {
		$('#gotomsdnaa').submit(function() {
			$('#msdnaabutton').prop('disabled', true);
		});
		$('#akkoord').change(function() {
			$('#msdnaabutton').prop('disabled', !$('#akkoord').is(':checked'));
		});
	});
	</script>

	<div class="messageBox">
	<form id="gotomsdnaa" action="elms2.php" method="post">
		<input type="checkbox" name="akkoord" id="akkoord" value="akkoord"><label for="akkoord"><?=__('Ik ga er mee akkoord dat mijn naam en e-mailadres worden doorgestuurd naar Microsoft.')?></label><br />
		<button class="button" id="msdnaabutton" disabled="disabled"><?=__('Ga naar Dreamspark')?></button>
	</form>
	</div>
<? } ?>
